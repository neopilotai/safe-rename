name: Safe Rename Bot

on:
  workflow_dispatch:
    inputs:
      old-name:
        description: 'Old name to rename'
        required: true
        type: string
      new-name:
        description: 'New name to rename'
        required: true
        type: string
      update-package:
        description: 'Update package.json'
        required: false
        type: boolean
        default: true
      update-remote:
        description: 'Update git remotes'
        required: false
        type: boolean
        default: false
      dry-run:
        description: 'Dry run (preview changes only)'
        required: false
        type: boolean
        default: false
      case-sensitive:
        description: 'Case sensitive rename'
        required: false
        type: boolean
        default: false
      concurrency:
        description: 'Number of concurrent files to process'
        required: false
        type: string
        default: '10'
      create-pr:
        description: 'Create pull request'
        required: false
        type: boolean
        default: true
      pr-branch:
        description: 'PR branch name'
        required: false
        type: string
        default: 'refactor/safe-rename'
  push:
    branches: [main]

env:
  OLD_NAME: ${{ github.event.inputs.old-name || 'opencode' }}
  NEW_NAME: ${{ github.event.inputs.new-name || 'fastcode' }}

jobs:
  rename:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Validate inputs
        run: |
          if [ -z "$OLD_NAME" ]; then
            echo "Error: old-name is required"
            exit 1
          fi
          if [ -z "$NEW_NAME" ]; then
            echo "Error: new-name is required"
            exit 1
          fi
          echo "‚úÖ Inputs validated"

      - name: Run Safe Rename
        run: |
          UPDATE_PACKAGE="${{ github.event.inputs.update-package || 'true' }}"
          UPDATE_REMOTE="${{ github.event.inputs.update-remote || 'false' }}"
          DRY_RUN="${{ github.event.inputs.dry-run || 'false' }}"
          CASE_SENSITIVE="${{ github.event.inputs.case-sensitive || 'false' }}"
          CONCURRENCY="${{ github.event.inputs.concurrency || '10' }}"
          
          echo "üîÑ Starting safe rename: $OLD_NAME ‚Üí $NEW_NAME"
          echo "üìã Configuration:"
          echo "  - Update package.json: $UPDATE_PACKAGE"
          echo "  - Update git remotes: $UPDATE_REMOTE"
          echo "  - Dry run: $DRY_RUN"
          echo "  - Case sensitive: $CASE_SENSITIVE"
          echo "  - Concurrency: $CONCURRENCY"
          
          bunx safe-rename \
            --old-name "$OLD_NAME" \
            --new-name "$NEW_NAME" \
            --update-package="$UPDATE_PACKAGE" \
            --update-remote="$UPDATE_REMOTE" \
            --dry="$DRY_RUN" \
            --case-sensitive="$CASE_SENSITIVE" \
            --concurrency="$CONCURRENCY"

      - name: Configure Git
        if: github.event.inputs.create-pr != 'false'
        run: |
          git config --global user.name "safe-rename-bot"
          git config --global user.email "bot@users.noreply.github.com"

      - name: Create and checkout PR branch
        if: github.event.inputs.create-pr != 'false'
        run: |
          BRANCH_NAME="${{ github.event.inputs.pr-branch || 'refactor/safe-rename' }}"
          git checkout -b "$BRANCH_NAME"
          git add .
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            git commit -m "chore: automated rename $OLD_NAME ‚Üí $NEW_NAME"
            echo "‚úÖ Changes committed"
          fi

      - name: Create Pull Request
        if: github.event.inputs.create-pr != 'false'
        uses: peter-evans/create-pull-request@v8
        with:
          title: "Automated rename: $OLD_NAME ‚Üí $NEW_NAME"
          body: |
            ## ü§ñ Automated Safe Rename
            
            This PR was generated by the Safe Rename Bot.
            
            **Changes:**
            - Renamed `$OLD_NAME` to `$NEW_NAME` across the codebase
            - Updated package.json: ${{ github.event.inputs.update-package || 'true' }}
            - Updated git remotes: ${{ github.event.inputs.update-remote || 'false' }}
            - Case sensitive: ${{ github.event.inputs.case-sensitive || 'false' }}
            
            **Configuration:**
            - Dry run: ${{ github.event.inputs.dry-run || 'false' }}
            - Concurrency: ${{ github.event.inputs.concurrency || '10' }}
            
            ---
            
            üìù [Safe Rename Documentation](https://github.com/neopilotai/safe-rename)
            üêõ [Report Issues](https://github.com/neopilotai/safe-rename/issues)
          branch: ${{ github.event.inputs.pr-branch || 'refactor/safe-rename' }}
          delete-branch: true
          labels: |
            automated
            safe-rename
            refactor
